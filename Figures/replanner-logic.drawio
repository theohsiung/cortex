<mxGraphModel>
  <root>
    <mxCell id="0"/>
    <mxCell id="1" parent="0"/>

    <!-- Title -->
    <mxCell id="title" value="Replanner 運作邏輯" style="text;html=1;fontSize=20;fontStyle=1;align=center;verticalAlign=middle;fillColor=none;strokeColor=none;fontColor=#1a1a2e;" vertex="1" parent="1">
      <mxGeometry x="220" y="10" width="360" height="40" as="geometry"/>
    </mxCell>

    <!-- ============ CORTEX ORCHESTRATOR (outer box) ============ -->
    <mxCell id="cortex-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;strokeWidth=2;dashed=1;arcSize=8;" vertex="1" parent="1">
      <mxGeometry x="30" y="55" width="740" height="900" as="geometry"/>
    </mxCell>
    <mxCell id="cortex-label" value="Cortex Orchestrator" style="text;html=1;fontSize=13;fontStyle=1;align=left;verticalAlign=top;fillColor=none;strokeColor=none;fontColor=#666666;" vertex="1" parent="1">
      <mxGeometry x="40" y="58" width="180" height="24" as="geometry"/>
    </mxCell>

    <!-- ============ EXECUTION PHASE ============ -->
    <!-- Step Execution -->
    <mxCell id="exec" value="&lt;b&gt;Step 執行&lt;/b&gt;&lt;br&gt;Executor 執行當前 Step" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=12;arcSize=20;" vertex="1" parent="1">
      <mxGeometry x="300" y="90" width="200" height="55" as="geometry"/>
    </mxCell>

    <!-- Verification -->
    <mxCell id="verify" value="&lt;b&gt;Verifier 驗證&lt;/b&gt;&lt;br&gt;機械檢查 + LLM 評估" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=12;arcSize=20;" vertex="1" parent="1">
      <mxGeometry x="300" y="185" width="200" height="55" as="geometry"/>
    </mxCell>

    <!-- Arrow: exec -> verify -->
    <mxCell id="e-exec-verify" style="endArrow=classic;strokeColor=#333333;strokeWidth=1.5;" edge="1" source="exec" target="verify" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Decision: Passed? -->
    <mxCell id="decision-pass" value="驗證通過？" style="rhombus;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;fontStyle=1;arcSize=20;" vertex="1" parent="1">
      <mxGeometry x="335" y="280" width="130" height="70" as="geometry"/>
    </mxCell>

    <!-- Arrow: verify -> decision -->
    <mxCell id="e-verify-dec" style="endArrow=classic;strokeColor=#333333;strokeWidth=1.5;" edge="1" source="verify" target="decision-pass" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Passed: Mark completed -->
    <mxCell id="completed" value="&lt;b&gt;標記 completed&lt;/b&gt;&lt;br&gt;儲存 step_output" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=12;arcSize=20;" vertex="1" parent="1">
      <mxGeometry x="560" y="285" width="180" height="55" as="geometry"/>
    </mxCell>

    <!-- Arrow: decision -> completed (Yes) -->
    <mxCell id="e-dec-comp" value="Yes" style="endArrow=classic;strokeColor=#82b366;strokeWidth=1.5;fontStyle=1;fontSize=11;fontColor=#82b366;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" source="decision-pass" target="completed" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Next Step / Done -->
    <mxCell id="next-step" value="繼續下一個&lt;br&gt;Ready Step" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=12;arcSize=20;" vertex="1" parent="1">
      <mxGeometry x="595" y="100" width="140" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="e-comp-next" style="endArrow=classic;strokeColor=#82b366;strokeWidth=1.5;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" source="completed" target="next-step" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- ============ REPLAN BRANCH ============ -->
    <!-- Decision: Replan limit? -->
    <mxCell id="decision-limit" value="global_replan_count&lt;br&gt;&amp;lt; max_replan?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;fontStyle=1;" vertex="1" parent="1">
      <mxGeometry x="295" y="400" width="210" height="80" as="geometry"/>
    </mxCell>

    <!-- Arrow: decision-pass -> decision-limit (No) -->
    <mxCell id="e-dec-limit" value="No" style="endArrow=classic;strokeColor=#b85450;strokeWidth=1.5;fontStyle=1;fontSize=11;fontColor=#b85450;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" source="decision-pass" target="decision-limit" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Blocked -->
    <mxCell id="blocked" value="&lt;b&gt;標記 blocked&lt;/b&gt;&lt;br&gt;放棄此 Step" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12;arcSize=20;" vertex="1" parent="1">
      <mxGeometry x="560" y="415" width="170" height="50" as="geometry"/>
    </mxCell>

    <!-- Arrow: decision-limit -> blocked (No) -->
    <mxCell id="e-limit-block" value="No (超過上限)" style="endArrow=classic;strokeColor=#b85450;strokeWidth=1.5;fontStyle=1;fontSize=11;fontColor=#b85450;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" source="decision-limit" target="blocked" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- ============ REPLANNER AGENT BOX ============ -->
    <mxCell id="replan-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e6d0de;strokeColor=#996699;strokeWidth=2;dashed=1;arcSize=8;" vertex="1" parent="1">
      <mxGeometry x="60" y="530" width="680" height="400" as="geometry"/>
    </mxCell>
    <mxCell id="replan-label" value="ReplannerAgent" style="text;html=1;fontSize=13;fontStyle=1;align=left;verticalAlign=top;fillColor=none;strokeColor=none;fontColor=#996699;" vertex="1" parent="1">
      <mxGeometry x="70" y="533" width="160" height="24" as="geometry"/>
    </mxCell>

    <!-- Arrow: decision-limit -> replan-box (Yes) -->
    <mxCell id="e-limit-replan" value="Yes (可重試)" style="endArrow=classic;strokeColor=#996699;strokeWidth=1.5;fontStyle=1;fontSize=11;fontColor=#996699;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" source="decision-limit" target="build-prompt" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Build Prompt -->
    <mxCell id="build-prompt" value="&lt;b&gt;建構 Prompt&lt;/b&gt;&lt;br&gt;• 原始 query&lt;br&gt;• 已完成 steps + tool history&lt;br&gt;• 失敗 step (output / reason)&lt;br&gt;• 可用 tools &amp;amp; intents&lt;br&gt;• 第 N 次嘗試 (escalation)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;align=left;spacingLeft=8;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="80" y="565" width="240" height="110" as="geometry"/>
    </mxCell>

    <!-- LLM Call -->
    <mxCell id="llm-call" value="&lt;b&gt;LLM 呼叫&lt;/b&gt;&lt;br&gt;產生 ReplanResult" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;arcSize=20;" vertex="1" parent="1">
      <mxGeometry x="80" y="710" width="240" height="50" as="geometry"/>
    </mxCell>

    <!-- Arrow: build-prompt -> llm-call -->
    <mxCell id="e-bp-llm" style="endArrow=classic;strokeColor=#9673a6;strokeWidth=1.5;" edge="1" source="build-prompt" target="llm-call" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Parse Response -->
    <mxCell id="parse" value="&lt;b&gt;解析回應&lt;/b&gt;&lt;br&gt;_parse_response()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;arcSize=20;" vertex="1" parent="1">
      <mxGeometry x="80" y="795" width="240" height="50" as="geometry"/>
    </mxCell>

    <!-- Arrow: llm-call -> parse -->
    <mxCell id="e-llm-parse" style="endArrow=classic;strokeColor=#9673a6;strokeWidth=1.5;" edge="1" source="llm-call" target="parse" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Decision: action? -->
    <mxCell id="decision-action" value="action?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;fontStyle=1;" vertex="1" parent="1">
      <mxGeometry x="140" y="875" width="120" height="50" as="geometry"/>
    </mxCell>

    <!-- Arrow: parse -> decision-action -->
    <mxCell id="e-parse-act" style="endArrow=classic;strokeColor=#9673a6;strokeWidth=1.5;" edge="1" source="parse" target="decision-action" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- give_up path -->
    <mxCell id="give-up" value="give_up" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12;fontStyle=1;arcSize=20;" vertex="1" parent="1">
      <mxGeometry x="80" y="880" width="55" height="40" as="geometry"/>
    </mxCell>
    <mxCell id="e-act-giveup" value="" style="endArrow=classic;strokeColor=#b85450;strokeWidth=1.5;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" source="decision-action" target="give-up" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- ReplanResult Box -->
    <mxCell id="replan-result" value="&lt;b&gt;ReplanResult&lt;/b&gt;&lt;br&gt;• action: &quot;redesign&quot;&lt;br&gt;• failed_step_description&lt;br&gt;• failed_step_intent&lt;br&gt;• continuation_steps&lt;br&gt;• continuation_dependencies&lt;br&gt;• continuation_intents" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;align=left;spacingLeft=8;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="400" y="560" width="220" height="130" as="geometry"/>
    </mxCell>

    <!-- Arrow: decision-action -> replan-result (redesign) -->
    <mxCell id="e-act-result" value="redesign" style="endArrow=classic;strokeColor=#d79b00;strokeWidth=1.5;fontStyle=1;fontSize=11;fontColor=#d79b00;exitX=1;exitY=0.5;exitDx=0;exitDy=0;curved=1;" edge="1" source="decision-action" target="replan-result" parent="1">
      <mxGeometry relative="1" as="geometry">
        <Array as="points">
          <mxPoint x="360" y="900"/>
          <mxPoint x="680" y="850"/>
          <mxPoint x="680" y="650"/>
        </Array>
      </mxGeometry>
    </mxCell>

    <!-- ============ APPLY REPLAN (3 phases) ============ -->
    <!-- Phase 1: Drop downstream -->
    <mxCell id="phase1" value="&lt;b&gt;1. 刪除下游 Steps&lt;/b&gt;&lt;br&gt;_get_downstream()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="400" y="720" width="220" height="50" as="geometry"/>
    </mxCell>

    <!-- Phase 2: Reset failed step -->
    <mxCell id="phase2" value="&lt;b&gt;2. 重設失敗 Step&lt;/b&gt;&lt;br&gt;清空 history / files / notes&lt;br&gt;更新 description &amp;amp; intent&lt;br&gt;狀態 → not_started" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="400" y="790" width="220" height="75" as="geometry"/>
    </mxCell>

    <!-- Phase 3: Add continuations -->
    <mxCell id="phase3" value="&lt;b&gt;3. 加入 Continuation Steps&lt;/b&gt;&lt;br&gt;local ID → actual ID&lt;br&gt;root 接 terminal nodes&lt;br&gt;建立 DAG 依賴" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="400" y="885" width="220" height="70" as="geometry"/>
    </mxCell>

    <!-- Arrows between phases -->
    <mxCell id="e-result-p1" style="endArrow=classic;strokeColor=#d79b00;strokeWidth=1.5;" edge="1" source="replan-result" target="phase1" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="e-p1-p2" style="endArrow=classic;strokeColor=#d79b00;strokeWidth=1.5;" edge="1" source="phase1" target="phase2" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="e-p2-p3" style="endArrow=classic;strokeColor=#d79b00;strokeWidth=1.5;" edge="1" source="phase2" target="phase3" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Back to execution -->
    <mxCell id="e-p3-exec" value="回到執行迴圈" style="endArrow=classic;strokeColor=#6c8ebf;strokeWidth=2;fontStyle=1;fontSize=11;fontColor=#6c8ebf;dashed=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;curved=1;" edge="1" source="phase3" target="exec" parent="1">
      <mxGeometry relative="1" as="geometry">
        <Array as="points">
          <mxPoint x="750" y="920"/>
          <mxPoint x="760" y="115"/>
        </Array>
      </mxGeometry>
    </mxCell>

    <!-- ============ DAG EXAMPLE ============ -->
    <!-- Example: Before -->
    <mxCell id="ex-label-before" value="apply_replan 範例" style="text;html=1;fontSize=11;fontStyle=5;align=center;fillColor=none;strokeColor=none;fontColor=#996699;" vertex="1" parent="1">
      <mxGeometry x="60" y="165" width="130" height="20" as="geometry"/>
    </mxCell>

    <mxCell id="ex-s0" value="S0 ✓" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;fontStyle=1;" vertex="1" parent="1">
      <mxGeometry x="100" y="190" width="45" height="30" as="geometry"/>
    </mxCell>
    <mxCell id="ex-s1" value="S1 ✗" style="ellipse;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;fontStyle=1;" vertex="1" parent="1">
      <mxGeometry x="100" y="235" width="45" height="30" as="geometry"/>
    </mxCell>
    <mxCell id="ex-s2" value="S2" style="ellipse;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#999999;fontSize=10;fontStyle=0;" vertex="1" parent="1">
      <mxGeometry x="70" y="280" width="40" height="28" as="geometry"/>
    </mxCell>
    <mxCell id="ex-s3" value="S3" style="ellipse;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#999999;fontSize=10;" vertex="1" parent="1">
      <mxGeometry x="135" y="280" width="40" height="28" as="geometry"/>
    </mxCell>
    <mxCell id="ex-e01" style="endArrow=classic;strokeColor=#333;strokeWidth=1;" edge="1" source="ex-s0" target="ex-s1" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="ex-e12" style="endArrow=classic;strokeColor=#999;strokeWidth=1;" edge="1" source="ex-s1" target="ex-s2" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="ex-e13" style="endArrow=classic;strokeColor=#999;strokeWidth=1;" edge="1" source="ex-s1" target="ex-s3" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Arrow indicator -->
    <mxCell id="ex-arrow" value="→" style="text;html=1;fontSize=16;fontStyle=1;align=center;fillColor=none;strokeColor=none;fontColor=#996699;" vertex="1" parent="1">
      <mxGeometry x="112" y="320" width="30" height="20" as="geometry"/>
    </mxCell>

    <!-- Example: After -->
    <mxCell id="ex-s0b" value="S0 ✓" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;fontStyle=1;" vertex="1" parent="1">
      <mxGeometry x="100" y="347" width="45" height="30" as="geometry"/>
    </mxCell>
    <mxCell id="ex-s1b" value="S1'" style="ellipse;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;fontStyle=1;" vertex="1" parent="1">
      <mxGeometry x="100" y="392" width="45" height="30" as="geometry"/>
    </mxCell>
    <mxCell id="ex-new2" value="New" style="ellipse;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;fontStyle=1;" vertex="1" parent="1">
      <mxGeometry x="100" y="437" width="45" height="28" as="geometry"/>
    </mxCell>
    <mxCell id="ex-e01b" style="endArrow=classic;strokeColor=#333;strokeWidth=1;" edge="1" source="ex-s0b" target="ex-s1b" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="ex-e1nb" style="endArrow=classic;strokeColor=#9673a6;strokeWidth=1;" edge="1" source="ex-s1b" target="ex-new2" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Legend labels for example -->
    <mxCell id="ex-before-label" value="Before" style="text;html=1;fontSize=10;fontStyle=2;fillColor=none;strokeColor=none;fontColor=#666;" vertex="1" parent="1">
      <mxGeometry x="155" y="235" width="55" height="16" as="geometry"/>
    </mxCell>
    <mxCell id="ex-after-label" value="After" style="text;html=1;fontSize=10;fontStyle=2;fillColor=none;strokeColor=none;fontColor=#666;" vertex="1" parent="1">
      <mxGeometry x="155" y="392" width="55" height="16" as="geometry"/>
    </mxCell>
    <mxCell id="ex-drop-label" value="S2,S3 刪除" style="text;html=1;fontSize=9;fontStyle=2;fillColor=none;strokeColor=none;fontColor=#b85450;" vertex="1" parent="1">
      <mxGeometry x="60" y="310" width="70" height="14" as="geometry"/>
    </mxCell>

  </root>
</mxGraphModel>