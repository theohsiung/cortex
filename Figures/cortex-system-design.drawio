<mxGraphModel>
  <root>
    <mxCell id="0"/>
    <mxCell id="1" parent="0"/>

    <!-- ===== TITLE ===== -->
    <mxCell id="title" value="Cortex — System Architecture" style="text;html=1;fontSize=22;fontStyle=1;align=center;verticalAlign=middle;fillColor=none;strokeColor=none;fontColor=#1a1a2e;" vertex="1" parent="1">
      <mxGeometry x="300" y="8" width="400" height="32" as="geometry"/>
    </mxCell>

    <!-- ========================================================================= -->
    <!-- CLIENT LAYER -->
    <!-- ========================================================================= -->
    <mxCell id="client-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#9e9e9e;strokeWidth=1.5;dashed=1;arcSize=6;" vertex="1" parent="1">
      <mxGeometry x="20" y="48" width="960" height="65" as="geometry"/>
    </mxCell>
    <mxCell id="client-label" value="Client Layer" style="text;html=1;fontSize=11;fontStyle=1;fillColor=none;strokeColor=none;fontColor=#616161;" vertex="1" parent="1">
      <mxGeometry x="30" y="50" width="100" height="16" as="geometry"/>
    </mxCell>

    <mxCell id="client-api" value="&lt;b&gt;cortex.execute(query, on_event)&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;Async Python API · Event callback streaming&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e0e0e0;strokeColor=#9e9e9e;fontSize=10;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="190" y="68" width="260" height="38" as="geometry"/>
    </mxCell>

    <mxCell id="client-config" value="&lt;b&gt;CortexConfig&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;.cortex/config.toml · ENV · Constructor&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e0e0e0;strokeColor=#9e9e9e;fontSize=10;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="550" y="68" width="240" height="38" as="geometry"/>
    </mxCell>

    <!-- ========================================================================= -->
    <!-- ORCHESTRATION LAYER -->
    <!-- ========================================================================= -->
    <mxCell id="orch-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e3f2fd;strokeColor=#42a5f5;strokeWidth=2;arcSize=4;" vertex="1" parent="1">
      <mxGeometry x="20" y="128" width="960" height="250" as="geometry"/>
    </mxCell>
    <mxCell id="orch-label" value="Orchestration Layer — Cortex" style="text;html=1;fontSize=12;fontStyle=1;fillColor=none;strokeColor=none;fontColor=#1565c0;" vertex="1" parent="1">
      <mxGeometry x="32" y="131" width="250" height="18" as="geometry"/>
    </mxCell>

    <!-- TaskManager -->
    <mxCell id="task-mgr" value="&lt;b&gt;TaskManager&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;Singleton · Thread-safe&lt;br&gt;dict[plan_id, Plan]&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#42a5f5;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="40" y="158" width="150" height="52" as="geometry"/>
    </mxCell>

    <!-- Plan -->
    <mxCell id="plan" value="&lt;b&gt;Plan (DAG)&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;steps · dependencies · step_statuses&lt;br&gt;step_intents · step_tool_history&lt;br&gt;step_files · step_notes&lt;br&gt;global_replan_count&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#42a5f5;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="40" y="225" width="200" height="75" as="geometry"/>
    </mxCell>

    <mxCell id="e-tm-plan" style="endArrow=classic;strokeColor=#42a5f5;strokeWidth=1;dashed=1;" edge="1" source="task-mgr" target="plan" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Execution Loop -->
    <mxCell id="exec-loop" value="&lt;b&gt;Execution Loop&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;get_ready_steps() → asyncio.gather()&lt;br&gt;Semaphore(max_concurrent_steps)&lt;br&gt;Intent routing → Executor dispatch&lt;br&gt;Verify → Pass / Replan / Block&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#90caf9;strokeColor=#1976d2;fontSize=10;arcSize=10;fontColor=#0d47a1;" vertex="1" parent="1">
      <mxGeometry x="310" y="155" width="260" height="78" as="geometry"/>
    </mxCell>

    <!-- Event System -->
    <mxCell id="events" value="&lt;b&gt;Event System&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;on_event(type, data)&lt;br&gt;plan_created · plan_updated&lt;br&gt;step_status · replanning&lt;br&gt;execution_complete&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#42a5f5;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="640" y="155" width="180" height="78" as="geometry"/>
    </mxCell>

    <!-- Retry / Tuning -->
    <mxCell id="tuning" value="&lt;b&gt;TuningConfig&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;max_concurrent_steps: 3&lt;br&gt;max_retries: 3&lt;br&gt;max_replan_attempts: 2&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#42a5f5;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="860" y="155" width="110" height="68" as="geometry"/>
    </mxCell>

    <!-- Aggregator -->
    <mxCell id="aggregator" value="&lt;b&gt;Aggregator&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;LlmAgent (inline)&lt;br&gt;Synthesize step_outputs&lt;br&gt;→ final coherent result&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#42a5f5;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="380" y="255" width="170" height="62" as="geometry"/>
    </mxCell>

    <!-- Intent Router -->
    <mxCell id="intent-router" value="&lt;b&gt;Intent Router&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;step_intents[idx] → factory&lt;br&gt;ExecutorEntry.get_factory()&lt;br&gt;importlib dynamic import&lt;br&gt;fallback → first executor&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#42a5f5;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="620" y="255" width="190" height="68" as="geometry"/>
    </mxCell>

    <!-- Arrows within orchestration -->
    <mxCell id="e-loop-plan" style="endArrow=classic;startArrow=classic;strokeColor=#1976d2;strokeWidth=1;" edge="1" source="exec-loop" target="plan" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="e-loop-events" style="endArrow=classic;strokeColor=#42a5f5;strokeWidth=1;dashed=1;" edge="1" source="exec-loop" target="events" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="e-loop-agg" style="endArrow=classic;strokeColor=#1976d2;strokeWidth=1;" edge="1" source="exec-loop" target="aggregator" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="e-loop-router" style="endArrow=classic;strokeColor=#1976d2;strokeWidth=1;" edge="1" source="exec-loop" target="intent-router" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- ========================================================================= -->
    <!-- AGENT LAYER -->
    <!-- ========================================================================= -->
    <mxCell id="agent-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff3e0;strokeColor=#ff9800;strokeWidth=2;arcSize=4;" vertex="1" parent="1">
      <mxGeometry x="20" y="398" width="960" height="195" as="geometry"/>
    </mxCell>
    <mxCell id="agent-label" value="Agent Layer — Google ADK Agents" style="text;html=1;fontSize=12;fontStyle=1;fillColor=none;strokeColor=none;fontColor=#e65100;" vertex="1" parent="1">
      <mxGeometry x="32" y="401" width="280" height="18" as="geometry"/>
    </mxCell>

    <!-- BaseAgent -->
    <mxCell id="base-agent" value="&lt;b&gt;BaseAgent&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;Wraps any ADK agent (LlmAgent, LoopAgent, ...)&lt;br&gt;Tool call tracking: pending → success&lt;br&gt;File extraction (write_file, shell redirect, Python open)&lt;br&gt;Auto retry: malformed JSON / hallucinated tool names&lt;br&gt;ExecutionContext: step isolation for parallel exec&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe0b2;strokeColor=#ff9800;fontSize=10;arcSize=8;" vertex="1" parent="1">
      <mxGeometry x="30" y="422" width="320" height="82" as="geometry"/>
    </mxCell>

    <!-- PlannerAgent -->
    <mxCell id="planner" value="&lt;b&gt;PlannerAgent&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;Tools: create_plan,&lt;br&gt;update_plan&lt;br&gt;+ RO filesystem&lt;br&gt;+ intent injection&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff9c4;strokeColor=#f9a825;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="30" y="520" width="130" height="68" as="geometry"/>
    </mxCell>

    <!-- ExecutorAgent (Internal) -->
    <mxCell id="executor-int" value="&lt;b&gt;ExecutorAgent&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;Internal default&lt;br&gt;LlmAgent + sandbox tools&lt;br&gt;0-call nudge retry&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#c8e6c9;strokeColor=#43a047;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="185" y="520" width="140" height="68" as="geometry"/>
    </mxCell>

    <!-- External Executor -->
    <mxCell id="executor-ext" value="&lt;b&gt;External Executor&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;ExecutorEntry.factory()&lt;br&gt;User-defined ADK Agent&lt;br&gt;Custom tools / logic&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#c8e6c9;strokeColor=#43a047;fontSize=10;arcSize=10;strokeDasharray=4;" vertex="1" parent="1">
      <mxGeometry x="350" y="520" width="140" height="68" as="geometry"/>
    </mxCell>

    <!-- Verifier -->
    <mxCell id="verifier" value="&lt;b&gt;Verifier&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;1. verify_step()&lt;br&gt;&amp;nbsp;&amp;nbsp; pending calls / [FAIL] marker&lt;br&gt;2. evaluate_output()&lt;br&gt;&amp;nbsp;&amp;nbsp; LLM process check&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcdd2;strokeColor=#e53935;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="520" y="520" width="170" height="68" as="geometry"/>
    </mxCell>

    <!-- ReplannerAgent -->
    <mxCell id="replanner" value="&lt;b&gt;ReplannerAgent&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;LLM (no tools)&lt;br&gt;→ ReplanResult JSON&lt;br&gt;Plan.apply_replan()&lt;br&gt;drop / reset / continue&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1bee7;strokeColor=#8e24aa;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="720" y="520" width="145" height="68" as="geometry"/>
    </mxCell>

    <!-- GenericLoop -->
    <mxCell id="generic-loop" value="&lt;b&gt;GenericLoop&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;Loop sub-agents&lt;br&gt;exit_loop_action&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe0b2;strokeColor=#ff9800;fontSize=10;arcSize=10;strokeDasharray=4;" vertex="1" parent="1">
      <mxGeometry x="890" y="520" width="80" height="63" as="geometry"/>
    </mxCell>

    <!-- Inheritance arrows -->
    <mxCell id="e-base-planner" style="endArrow=block;endFill=0;strokeColor=#ff9800;strokeWidth=1;dashed=1;" edge="1" source="planner" target="base-agent" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="e-base-execint" style="endArrow=block;endFill=0;strokeColor=#ff9800;strokeWidth=1;dashed=1;" edge="1" source="executor-int" target="base-agent" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="e-base-replan" style="endArrow=block;endFill=0;strokeColor=#ff9800;strokeWidth=1;dashed=1;" edge="1" source="replanner" target="base-agent" parent="1">
      <mxGeometry relative="1" as="geometry">
        <Array as="points">
          <mxPoint x="792" y="490"/>
          <mxPoint x="340" y="490"/>
        </Array>
      </mxGeometry>
    </mxCell>

    <!-- Orchestrator -> Agent arrows -->
    <mxCell id="e-orch-planner" style="endArrow=classic;strokeColor=#f9a825;strokeWidth=1.5;exitX=0.15;exitY=1;exitDx=0;exitDy=0;" edge="1" source="orch-box" target="planner" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="e-orch-execint" style="endArrow=classic;strokeColor=#43a047;strokeWidth=1.5;" edge="1" source="orch-box" target="executor-int" parent="1">
      <mxGeometry relative="1" as="geometry">
        <mxPoint x="280" y="378" as="sourcePoint"/>
      </mxGeometry>
    </mxCell>
    <mxCell id="e-router-ext" style="endArrow=classic;strokeColor=#43a047;strokeWidth=1.5;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" source="intent-router" target="executor-ext" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="e-orch-verifier" style="endArrow=classic;strokeColor=#e53935;strokeWidth=1.5;" edge="1" source="orch-box" target="verifier" parent="1">
      <mxGeometry relative="1" as="geometry">
        <mxPoint x="600" y="378" as="sourcePoint"/>
      </mxGeometry>
    </mxCell>
    <mxCell id="e-orch-replanner" style="endArrow=classic;strokeColor=#8e24aa;strokeWidth=1.5;" edge="1" source="orch-box" target="replanner" parent="1">
      <mxGeometry relative="1" as="geometry">
        <mxPoint x="780" y="378" as="sourcePoint"/>
      </mxGeometry>
    </mxCell>

    <!-- ========================================================================= -->
    <!-- TOOL / INFRASTRUCTURE LAYER -->
    <!-- ========================================================================= -->
    <mxCell id="infra-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#5c6bc0;strokeWidth=2;arcSize=4;" vertex="1" parent="1">
      <mxGeometry x="20" y="613" width="960" height="165" as="geometry"/>
    </mxCell>
    <mxCell id="infra-label" value="Tool &amp; Infrastructure Layer" style="text;html=1;fontSize=12;fontStyle=1;fillColor=none;strokeColor=none;fontColor=#283593;" vertex="1" parent="1">
      <mxGeometry x="32" y="616" width="250" height="18" as="geometry"/>
    </mxCell>

    <!-- SandboxManager -->
    <mxCell id="sandbox" value="&lt;b&gt;SandboxManager&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;Lifecycle: start() / stop()&lt;br&gt;get_planner_tools() → RO&lt;br&gt;get_executor_tools() → Full&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#c5cae9;strokeColor=#5c6bc0;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="35" y="640" width="170" height="62" as="geometry"/>
    </mxCell>

    <!-- MCP Filesystem -->
    <mxCell id="mcp-fs" value="&lt;b&gt;MCP Filesystem&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;@anthropic/mcp-filesystem&lt;br&gt;stdio transport&lt;br&gt;RW (executor) / RO (planner)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d1c4e9;strokeColor=#7e57c2;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="230" y="640" width="170" height="62" as="geometry"/>
    </mxCell>

    <!-- MCP Shell -->
    <mxCell id="mcp-shell" value="&lt;b&gt;MCP Shell&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;shell_server.py&lt;br&gt;docker exec → container&lt;br&gt;run_command tool&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d1c4e9;strokeColor=#7e57c2;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="420" y="640" width="155" height="62" as="geometry"/>
    </mxCell>

    <!-- User MCP -->
    <mxCell id="mcp-user" value="&lt;b&gt;User MCP Servers&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;MCPStdio | MCPSse&lt;br&gt;config.mcp_servers[]&lt;br&gt;Custom toolsets&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d1c4e9;strokeColor=#7e57c2;fontSize=10;arcSize=10;strokeDasharray=4;" vertex="1" parent="1">
      <mxGeometry x="595" y="640" width="155" height="62" as="geometry"/>
    </mxCell>

    <!-- PlanToolkit -->
    <mxCell id="plan-toolkit" value="&lt;b&gt;PlanToolkit&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;create_plan · update_plan&lt;br&gt;FunctionDeclaration schema&lt;br&gt;Aliased tools (gpt-oss)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#c5cae9;strokeColor=#5c6bc0;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="775" y="640" width="175" height="62" as="geometry"/>
    </mxCell>

    <!-- Arrows: sandbox -> MCP tools -->
    <mxCell id="e-sb-fs" style="endArrow=classic;strokeColor=#7e57c2;strokeWidth=1;" edge="1" source="sandbox" target="mcp-fs" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="e-sb-shell" style="endArrow=classic;strokeColor=#7e57c2;strokeWidth=1;" edge="1" source="sandbox" target="mcp-shell" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="e-sb-user" style="endArrow=classic;strokeColor=#7e57c2;strokeWidth=1;dashed=1;" edge="1" source="sandbox" target="mcp-user" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Arrows: agents -> tools -->
    <mxCell id="e-planner-toolkit" style="endArrow=classic;strokeColor=#5c6bc0;strokeWidth=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" source="planner" target="plan-toolkit" parent="1">
      <mxGeometry relative="1" as="geometry">
        <Array as="points">
          <mxPoint x="95" y="605"/>
          <mxPoint x="862" y="605"/>
        </Array>
      </mxGeometry>
    </mxCell>

    <!-- ========================================================================= -->
    <!-- EXTERNAL SERVICES LAYER -->
    <!-- ========================================================================= -->
    <mxCell id="ext-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fce4ec;strokeColor=#e91e63;strokeWidth=2;arcSize=4;" vertex="1" parent="1">
      <mxGeometry x="20" y="798" width="960" height="105" as="geometry"/>
    </mxCell>
    <mxCell id="ext-label" value="External Services" style="text;html=1;fontSize=12;fontStyle=1;fillColor=none;strokeColor=none;fontColor=#880e4f;" vertex="1" parent="1">
      <mxGeometry x="32" y="801" width="150" height="18" as="geometry"/>
    </mxCell>

    <!-- LLM -->
    <mxCell id="llm" value="&lt;b&gt;LLM Provider&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;LiteLLM adapter&lt;br&gt;ModelConfig: name · api_base · api_key&lt;br&gt;Supports: OpenAI-compat, Gemini, etc.&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8bbd0;strokeColor=#e91e63;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="40" y="823" width="250" height="62" as="geometry"/>
    </mxCell>

    <!-- Google ADK -->
    <mxCell id="adk" value="&lt;b&gt;Google ADK&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;LlmAgent · LoopAgent · Runner&lt;br&gt;InMemorySessionService&lt;br&gt;McpToolset · FunctionTool&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8bbd0;strokeColor=#e91e63;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="370" y="823" width="220" height="62" as="geometry"/>
    </mxCell>

    <!-- Docker -->
    <mxCell id="docker" value="&lt;b&gt;Docker&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;cortex-sandbox:latest&lt;br&gt;/workspace mount&lt;br&gt;Auto-build if missing&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8bbd0;strokeColor=#e91e63;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="660" y="823" width="155" height="62" as="geometry"/>
    </mxCell>

    <!-- MCP Protocol -->
    <mxCell id="mcp-proto" value="&lt;b&gt;MCP Protocol&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;stdio · SSE&lt;br&gt;transports&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8bbd0;strokeColor=#e91e63;fontSize=10;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="870" y="830" width="100" height="48" as="geometry"/>
    </mxCell>

    <!-- Arrows: infra -> external -->
    <mxCell id="e-shell-docker" style="endArrow=classic;strokeColor=#e91e63;strokeWidth=1.5;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" source="mcp-shell" target="docker" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="e-mcp-proto" style="endArrow=classic;strokeColor=#e91e63;strokeWidth=1;dashed=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" source="mcp-user" target="mcp-proto" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- All agents -> LLM -->
    <mxCell id="e-agents-llm" value="LLM calls" style="endArrow=classic;strokeColor=#e91e63;strokeWidth=1.5;fontSize=10;fontColor=#880e4f;exitX=0.2;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" source="agent-box" target="llm" parent="1">
      <mxGeometry relative="1" as="geometry">
        <Array as="points">
          <mxPoint x="165" y="775"/>
        </Array>
      </mxGeometry>
    </mxCell>

    <!-- All agents -> ADK -->
    <mxCell id="e-agents-adk" value="ADK runtime" style="endArrow=classic;strokeColor=#e91e63;strokeWidth=1.5;fontSize=10;fontColor=#880e4f;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" source="agent-box" target="adk" parent="1">
      <mxGeometry relative="1" as="geometry">
        <Array as="points">
          <mxPoint x="480" y="775"/>
        </Array>
      </mxGeometry>
    </mxCell>

    <!-- ========================================================================= -->
    <!-- DATA FLOW LEGEND -->
    <!-- ========================================================================= -->
    <mxCell id="legend-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fafafa;strokeColor=#bdbdbd;strokeWidth=1;arcSize=8;" vertex="1" parent="1">
      <mxGeometry x="20" y="918" width="960" height="50" as="geometry"/>
    </mxCell>
    <mxCell id="legend-title" value="&lt;b&gt;Legend:&lt;/b&gt;" style="text;html=1;fontSize=10;fillColor=none;strokeColor=none;fontColor=#333;" vertex="1" parent="1">
      <mxGeometry x="30" y="924" width="50" height="16" as="geometry"/>
    </mxCell>

    <mxCell id="leg-solid" value="" style="endArrow=classic;strokeColor=#333;strokeWidth=1.5;" edge="1" parent="1">
      <mxGeometry relative="1" as="geometry">
        <mxPoint x="85" y="940" as="sourcePoint"/>
        <mxPoint x="125" y="940" as="targetPoint"/>
      </mxGeometry>
    </mxCell>
    <mxCell id="leg-solid-txt" value="Data / Control flow" style="text;html=1;fontSize=9;fillColor=none;strokeColor=none;fontColor=#333;" vertex="1" parent="1">
      <mxGeometry x="130" y="932" width="100" height="16" as="geometry"/>
    </mxCell>

    <mxCell id="leg-dash" value="" style="endArrow=classic;strokeColor=#333;strokeWidth=1;dashed=1;" edge="1" parent="1">
      <mxGeometry relative="1" as="geometry">
        <mxPoint x="250" y="940" as="sourcePoint"/>
        <mxPoint x="290" y="940" as="targetPoint"/>
      </mxGeometry>
    </mxCell>
    <mxCell id="leg-dash-txt" value="Event / Optional" style="text;html=1;fontSize=9;fillColor=none;strokeColor=none;fontColor=#333;" vertex="1" parent="1">
      <mxGeometry x="295" y="932" width="90" height="16" as="geometry"/>
    </mxCell>

    <mxCell id="leg-inherit" value="" style="endArrow=block;endFill=0;strokeColor=#ff9800;strokeWidth=1;dashed=1;" edge="1" parent="1">
      <mxGeometry relative="1" as="geometry">
        <mxPoint x="410" y="940" as="sourcePoint"/>
        <mxPoint x="450" y="940" as="targetPoint"/>
      </mxGeometry>
    </mxCell>
    <mxCell id="leg-inherit-txt" value="Inherits (BaseAgent)" style="text;html=1;fontSize=9;fillColor=none;strokeColor=none;fontColor=#333;" vertex="1" parent="1">
      <mxGeometry x="455" y="932" width="110" height="16" as="geometry"/>
    </mxCell>

    <mxCell id="leg-ext-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#333;strokeWidth=1;strokeDasharray=4;arcSize=10;" vertex="1" parent="1">
      <mxGeometry x="590" y="933" width="25" height="15" as="geometry"/>
    </mxCell>
    <mxCell id="leg-ext-txt" value="Extensible / User-defined" style="text;html=1;fontSize=9;fillColor=none;strokeColor=none;fontColor=#333;" vertex="1" parent="1">
      <mxGeometry x="620" y="932" width="130" height="16" as="geometry"/>
    </mxCell>

    <mxCell id="leg-color1" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e3f2fd;strokeColor=#42a5f5;strokeWidth=1;" vertex="1" parent="1">
      <mxGeometry x="770" y="924" width="12" height="12" as="geometry"/>
    </mxCell>
    <mxCell id="leg-c1-txt" value="Orch" style="text;html=1;fontSize=9;fillColor=none;strokeColor=none;" vertex="1" parent="1">
      <mxGeometry x="785" y="920" width="30" height="16" as="geometry"/>
    </mxCell>
    <mxCell id="leg-color2" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff3e0;strokeColor=#ff9800;strokeWidth=1;" vertex="1" parent="1">
      <mxGeometry x="820" y="924" width="12" height="12" as="geometry"/>
    </mxCell>
    <mxCell id="leg-c2-txt" value="Agent" style="text;html=1;fontSize=9;fillColor=none;strokeColor=none;" vertex="1" parent="1">
      <mxGeometry x="835" y="920" width="35" height="16" as="geometry"/>
    </mxCell>
    <mxCell id="leg-color3" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#5c6bc0;strokeWidth=1;" vertex="1" parent="1">
      <mxGeometry x="875" y="924" width="12" height="12" as="geometry"/>
    </mxCell>
    <mxCell id="leg-c3-txt" value="Infra" style="text;html=1;fontSize=9;fillColor=none;strokeColor=none;" vertex="1" parent="1">
      <mxGeometry x="890" y="920" width="30" height="16" as="geometry"/>
    </mxCell>
    <mxCell id="leg-color4" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fce4ec;strokeColor=#e91e63;strokeWidth=1;" vertex="1" parent="1">
      <mxGeometry x="925" y="924" width="12" height="12" as="geometry"/>
    </mxCell>
    <mxCell id="leg-c4-txt" value="Ext" style="text;html=1;fontSize=9;fillColor=none;strokeColor=none;" vertex="1" parent="1">
      <mxGeometry x="940" y="920" width="25" height="16" as="geometry"/>
    </mxCell>

    <!-- second row legend: key files -->
    <mxCell id="leg-files" value="&lt;font style=&quot;font-size:9&quot;&gt;&lt;b&gt;Key files:&lt;/b&gt; cortex.py · app/config.py · app/task/plan.py · app/agents/{planner,executor,verifier,replanner}/ · app/sandbox/sandbox_manager.py · app/tools/plan_toolkit.py&lt;/font&gt;" style="text;html=1;fillColor=none;strokeColor=none;fontColor=#666;" vertex="1" parent="1">
      <mxGeometry x="30" y="948" width="900" height="16" as="geometry"/>
    </mxCell>

  </root>
</mxGraphModel>