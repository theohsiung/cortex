<mxGraphModel>
  <root>
    <mxCell id="0"/>
    <mxCell id="1" parent="0"/>

    <!-- ===== TITLE ===== -->
    <mxCell id="title" value="Cortex 完整流程圖" style="text;html=1;fontSize=22;fontStyle=1;align=center;verticalAlign=middle;fillColor=none;strokeColor=none;fontColor=#1a1a2e;" vertex="1" parent="1">
      <mxGeometry x="250" y="5" width="300" height="35" as="geometry"/>
    </mxCell>

    <!-- ===== USER INPUT ===== -->
    <mxCell id="user" value="&lt;b&gt;User Query&lt;/b&gt;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666;fontSize=13;fontStyle=1;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="320" y="45" width="160" height="40" as="geometry"/>
    </mxCell>

    <!-- ===== CORTEX ORCHESTRATOR BOX ===== -->
    <mxCell id="cortex-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#333;strokeWidth=2;dashed=1;arcSize=6;" vertex="1" parent="1">
      <mxGeometry x="10" y="95" width="780" height="990" as="geometry"/>
    </mxCell>
    <mxCell id="cortex-label" value="Cortex Orchestrator (cortex.py)" style="text;html=1;fontSize=14;fontStyle=1;align=left;verticalAlign=top;fillColor=none;strokeColor=none;fontColor=#333;" vertex="1" parent="1">
      <mxGeometry x="20" y="98" width="280" height="22" as="geometry"/>
    </mxCell>

    <!-- Arrow: user -> init -->
    <mxCell id="e-user-init" style="endArrow=classic;strokeColor=#333;strokeWidth=1.5;" edge="1" source="user" target="init" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- ===== INIT ===== -->
    <mxCell id="init" value="&lt;b&gt;初始化&lt;/b&gt;&lt;br&gt;Plan + TaskManager&lt;br&gt;SandboxManager.start()&lt;br&gt;(Docker + MCP Toolsets)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e2e2e2;strokeColor=#999;fontSize=11;arcSize=15;" vertex="1" parent="1">
      <mxGeometry x="310" y="125" width="180" height="65" as="geometry"/>
    </mxCell>

    <!-- =========================================== -->
    <!-- ===== PHASE 1: PLANNING ===== -->
    <!-- =========================================== -->
    <mxCell id="phase1-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#eaf2ff;strokeColor=#6c8ebf;strokeWidth=1.5;dashed=1;arcSize=8;" vertex="1" parent="1">
      <mxGeometry x="30" y="210" width="740" height="150" as="geometry"/>
    </mxCell>
    <mxCell id="phase1-label" value="Phase 1: Planning" style="text;html=1;fontSize=13;fontStyle=1;align=left;fillColor=none;strokeColor=none;fontColor=#3a6ea5;" vertex="1" parent="1">
      <mxGeometry x="40" y="213" width="160" height="20" as="geometry"/>
    </mxCell>

    <mxCell id="planner" value="&lt;b&gt;PlannerAgent&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10&quot;&gt;LLM + create_plan / update_plan tools&lt;br&gt;+ read-only filesystem (sandbox)&lt;br&gt;+ available intents 注入 prompt&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;arcSize=15;" vertex="1" parent="1">
      <mxGeometry x="60" y="240" width="260" height="72" as="geometry"/>
    </mxCell>

    <mxCell id="plan-dag" value="&lt;b&gt;Plan (DAG)&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10&quot;&gt;steps: dict[int, str]&lt;br&gt;dependencies: dict[int, list[int]]&lt;br&gt;step_intents: dict[int, str]&lt;br&gt;step_statuses / step_notes&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;arcSize=15;" vertex="1" parent="1">
      <mxGeometry x="440" y="238" width="250" height="78" as="geometry"/>
    </mxCell>

    <!-- Arrow: planner -> plan-dag -->
    <mxCell id="e-planner-dag" value="create_plan()" style="endArrow=classic;strokeColor=#6c8ebf;strokeWidth=1.5;fontSize=10;fontColor=#6c8ebf;" edge="1" source="planner" target="plan-dag" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Arrow: init -> planner -->
    <mxCell id="e-init-planner" style="endArrow=classic;strokeColor=#333;strokeWidth=1.5;" edge="1" source="init" target="planner" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- =========================================== -->
    <!-- ===== PHASE 2: EXECUTION LOOP ===== -->
    <!-- =========================================== -->
    <mxCell id="phase2-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fdf6ec;strokeColor=#d6a656;strokeWidth=1.5;dashed=1;arcSize=6;" vertex="1" parent="1">
      <mxGeometry x="30" y="380" width="740" height="575" as="geometry"/>
    </mxCell>
    <mxCell id="phase2-label" value="Phase 2: Execution Loop (while ready_steps)" style="text;html=1;fontSize=13;fontStyle=1;align=left;fillColor=none;strokeColor=none;fontColor=#b8860b;" vertex="1" parent="1">
      <mxGeometry x="40" y="383" width="350" height="20" as="geometry"/>
    </mxCell>

    <!-- get_ready_steps -->
    <mxCell id="ready" value="&lt;b&gt;get_ready_steps()&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10&quot;&gt;取出依賴已滿足的 steps&lt;br&gt;(並行, Semaphore 限制)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;arcSize=15;" vertex="1" parent="1">
      <mxGeometry x="310" y="410" width="200" height="55" as="geometry"/>
    </mxCell>

    <!-- Arrow: plan-dag -> ready -->
    <mxCell id="e-dag-ready" style="endArrow=classic;strokeColor=#d6b656;strokeWidth=1.5;" edge="1" source="plan-dag" target="ready" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Intent dispatch -->
    <mxCell id="dispatch" value="&lt;b&gt;Intent Dispatch&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10&quot;&gt;step_intents[idx] → 路由&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;" vertex="1" parent="1">
      <mxGeometry x="330" y="490" width="160" height="65" as="geometry"/>
    </mxCell>

    <!-- Arrow: ready -> dispatch -->
    <mxCell id="e-ready-dispatch" style="endArrow=classic;strokeColor=#333;strokeWidth=1.5;" edge="1" source="ready" target="dispatch" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- ===== EXTERNAL EXECUTOR ===== -->
    <mxCell id="ext-exec-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8f5e9;strokeColor=#4caf50;strokeWidth=1.5;dashed=1;arcSize=8;" vertex="1" parent="1">
      <mxGeometry x="50" y="488" width="240" height="165" as="geometry"/>
    </mxCell>
    <mxCell id="ext-exec-label" value="External Executor" style="text;html=1;fontSize=11;fontStyle=1;align=left;fillColor=none;strokeColor=none;fontColor=#2e7d32;" vertex="1" parent="1">
      <mxGeometry x="58" y="491" width="140" height="18" as="geometry"/>
    </mxCell>

    <mxCell id="ext-exec" value="&lt;b&gt;ExecutorEntry.factory&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10&quot;&gt;config.executors 定義&lt;br&gt;factory_module + factory_function&lt;br&gt;透過 importlib 動態載入&lt;br&gt;→ 回傳自訂 ADK Agent&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#c8e6c9;strokeColor=#4caf50;fontSize=11;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="60" y="513" width="220" height="80" as="geometry"/>
    </mxCell>

    <mxCell id="ext-tools" value="&lt;font style=&quot;font-size:10&quot;&gt;tool_names: [web_search,&lt;br&gt;python_executor, ...]&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8f5e9;strokeColor=#81c784;fontSize=10;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="75" y="600" width="190" height="40" as="geometry"/>
    </mxCell>

    <!-- ===== INTERNAL EXECUTOR ===== -->
    <mxCell id="int-exec-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e3f2fd;strokeColor=#42a5f5;strokeWidth=1.5;dashed=1;arcSize=8;" vertex="1" parent="1">
      <mxGeometry x="530" y="488" width="230" height="165" as="geometry"/>
    </mxCell>
    <mxCell id="int-exec-label" value="Internal Executor (Default)" style="text;html=1;fontSize=11;fontStyle=1;align=left;fillColor=none;strokeColor=none;fontColor=#1565c0;" vertex="1" parent="1">
      <mxGeometry x="538" y="491" width="210" height="18" as="geometry"/>
    </mxCell>

    <mxCell id="int-exec" value="&lt;b&gt;ExecutorAgent&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10&quot;&gt;LlmAgent + EXECUTOR_PROMPT&lt;br&gt;Sandbox tools (filesystem,&lt;br&gt;shell, user MCP)&lt;br&gt;0 tool calls → nudge retry&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#42a5f5;fontSize=11;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="540" y="513" width="210" height="80" as="geometry"/>
    </mxCell>

    <mxCell id="int-tools" value="&lt;font style=&quot;font-size:10&quot;&gt;web_search, web_browser,&lt;br&gt;download_file, python_executor,&lt;br&gt;file_reader, shell (Docker)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e3f2fd;strokeColor=#90caf9;fontSize=10;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="547" y="600" width="195" height="44" as="geometry"/>
    </mxCell>

    <!-- Arrows: dispatch -> executors -->
    <mxCell id="e-dispatch-ext" value="有 factory" style="endArrow=classic;strokeColor=#4caf50;strokeWidth=1.5;fontStyle=1;fontSize=10;fontColor=#2e7d32;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.3;entryDx=0;entryDy=0;" edge="1" source="dispatch" target="ext-exec" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="e-dispatch-int" value="無 factory (default)" style="endArrow=classic;strokeColor=#42a5f5;strokeWidth=1.5;fontStyle=1;fontSize=10;fontColor=#1565c0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.3;entryDx=0;entryDy=0;" edge="1" source="dispatch" target="int-exec" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- ===== EXECUTOR OUTPUT → VERIFIER ===== -->
    <mxCell id="exec-output" value="&lt;b&gt;Executor Output&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#999;fontSize=12;arcSize=15;" vertex="1" parent="1">
      <mxGeometry x="335" y="675" width="150" height="35" as="geometry"/>
    </mxCell>

    <mxCell id="e-ext-output" style="endArrow=classic;strokeColor=#666;strokeWidth=1.5;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" source="ext-exec-box" target="exec-output" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="e-int-output" style="endArrow=classic;strokeColor=#666;strokeWidth=1.5;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" source="int-exec-box" target="exec-output" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- ===== VERIFIER ===== -->
    <mxCell id="verifier-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fce4ec;strokeColor=#e57373;strokeWidth=1.5;dashed=1;arcSize=8;" vertex="1" parent="1">
      <mxGeometry x="175" y="725" width="470" height="95" as="geometry"/>
    </mxCell>
    <mxCell id="verifier-label" value="Verifier (verifier.py)" style="text;html=1;fontSize=12;fontStyle=1;align=left;fillColor=none;strokeColor=none;fontColor=#c62828;" vertex="1" parent="1">
      <mxGeometry x="183" y="728" width="180" height="18" as="geometry"/>
    </mxCell>

    <mxCell id="v-mech" value="&lt;b&gt;1. 機械檢查&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10&quot;&gt;verify_step()&lt;br&gt;pending tool calls?&lt;br&gt;[FAIL] marker in notes?&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcdd2;strokeColor=#e57373;fontSize=11;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="190" y="750" width="185" height="60" as="geometry"/>
    </mxCell>

    <mxCell id="v-llm" value="&lt;b&gt;2. LLM 評估&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10&quot;&gt;evaluate_output()&lt;br&gt;[SUCCESS] / [FAIL]&lt;br&gt;檢查 process 而非結果正確性&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcdd2;strokeColor=#e57373;fontSize=11;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="395" y="750" width="235" height="60" as="geometry"/>
    </mxCell>

    <!-- Arrow: exec-output -> v-mech -->
    <mxCell id="e-out-mech" style="endArrow=classic;strokeColor=#e57373;strokeWidth=1.5;" edge="1" source="exec-output" target="v-mech" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Arrow: v-mech -> v-llm -->
    <mxCell id="e-mech-llm" value="passed" style="endArrow=classic;strokeColor=#e57373;strokeWidth=1.5;fontSize=10;fontColor=#c62828;" edge="1" source="v-mech" target="v-llm" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- ===== VERIFY DECISION ===== -->
    <mxCell id="v-decision" value="驗證通過？" style="rhombus;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;fontStyle=1;" vertex="1" parent="1">
      <mxGeometry x="350" y="840" width="120" height="55" as="geometry"/>
    </mxCell>

    <mxCell id="e-vbox-dec" style="endArrow=classic;strokeColor=#333;strokeWidth=1.5;" edge="1" source="verifier-box" target="v-decision" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- ===== PASSED PATH ===== -->
    <mxCell id="completed" value="&lt;b&gt;✓ completed&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10&quot;&gt;存入 step_outputs&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;arcSize=15;" vertex="1" parent="1">
      <mxGeometry x="570" y="843" width="150" height="45" as="geometry"/>
    </mxCell>

    <mxCell id="e-dec-pass" value="Yes" style="endArrow=classic;strokeColor=#82b366;strokeWidth=1.5;fontStyle=1;fontSize=11;fontColor=#82b366;" edge="1" source="v-decision" target="completed" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Loop back arrow: completed -> ready -->
    <mxCell id="e-comp-loop" value="" style="endArrow=classic;strokeColor=#82b366;strokeWidth=1.5;dashed=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;curved=1;" edge="1" source="completed" target="ready" parent="1">
      <mxGeometry relative="1" as="geometry">
        <Array as="points">
          <mxPoint x="750" y="866"/>
          <mxPoint x="755" y="437"/>
        </Array>
      </mxGeometry>
    </mxCell>

    <!-- ===== FAILED PATH ===== -->
    <mxCell id="replan-check" value="replan_count&lt;br&gt;&amp;lt; max?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;fontStyle=1;" vertex="1" parent="1">
      <mxGeometry x="120" y="838" width="120" height="60" as="geometry"/>
    </mxCell>

    <mxCell id="e-dec-fail" value="No" style="endArrow=classic;strokeColor=#b85450;strokeWidth=1.5;fontStyle=1;fontSize=11;fontColor=#b85450;" edge="1" source="v-decision" target="replan-check" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Blocked -->
    <mxCell id="blocked" value="&lt;b&gt;✗ blocked&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;fontStyle=1;arcSize=15;" vertex="1" parent="1">
      <mxGeometry x="140" y="920" width="80" height="30" as="geometry"/>
    </mxCell>
    <mxCell id="e-check-blocked" value="No" style="endArrow=classic;strokeColor=#b85450;strokeWidth=1.5;fontStyle=1;fontSize=10;fontColor=#b85450;" edge="1" source="replan-check" target="blocked" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- ===== REPLANNER ===== -->
    <mxCell id="replan-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f3e5f5;strokeColor=#9c27b0;strokeWidth=1.5;dashed=1;arcSize=8;" vertex="1" parent="1">
      <mxGeometry x="280" y="907" width="460" height="160" as="geometry"/>
    </mxCell>
    <mxCell id="replan-label" value="ReplannerAgent" style="text;html=1;fontSize=12;fontStyle=1;align=left;fillColor=none;strokeColor=none;fontColor=#7b1fa2;" vertex="1" parent="1">
      <mxGeometry x="290" y="910" width="150" height="18" as="geometry"/>
    </mxCell>

    <mxCell id="e-check-replan" value="Yes" style="endArrow=classic;strokeColor=#9c27b0;strokeWidth=1.5;fontStyle=1;fontSize=10;fontColor=#7b1fa2;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" source="replan-check" target="replan-prompt" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <mxCell id="replan-prompt" value="&lt;b&gt;Build Prompt&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10&quot;&gt;original_query + completed&lt;br&gt;steps + failed context&lt;br&gt;+ tool history + intents&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1bee7;strokeColor=#9c27b0;fontSize=11;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="290" y="932" width="175" height="65" as="geometry"/>
    </mxCell>

    <mxCell id="replan-llm" value="&lt;b&gt;LLM → ReplanResult&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10&quot;&gt;action: redesign / give_up&lt;br&gt;failed_step_description&lt;br&gt;continuation_steps&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1bee7;strokeColor=#9c27b0;fontSize=11;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="290" y="1005" width="175" height="55" as="geometry"/>
    </mxCell>

    <mxCell id="e-rprompt-rllm" style="endArrow=classic;strokeColor=#9c27b0;strokeWidth=1.5;" edge="1" source="replan-prompt" target="replan-llm" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- apply_replan -->
    <mxCell id="apply-replan" value="&lt;b&gt;apply_replan()&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10&quot;&gt;1. 刪除下游 steps&lt;br&gt;2. 重設失敗 step&lt;br&gt;3. 加入 continuation&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1bee7;strokeColor=#9c27b0;fontSize=11;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="530" y="930" width="190" height="65" as="geometry"/>
    </mxCell>

    <mxCell id="replan-giveup" value="give_up&lt;br&gt;→ blocked" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="545" y="1015" width="100" height="35" as="geometry"/>
    </mxCell>

    <mxCell id="e-rllm-apply" value="redesign" style="endArrow=classic;strokeColor=#9c27b0;strokeWidth=1.5;fontSize=10;fontColor=#7b1fa2;exitX=1;exitY=0;exitDx=0;exitDy=0;entryX=0;entryY=1;entryDx=0;entryDy=0;" edge="1" source="replan-llm" target="apply-replan" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <mxCell id="e-rllm-giveup" value="give_up" style="endArrow=classic;strokeColor=#b85450;strokeWidth=1.5;fontSize=10;fontColor=#b85450;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" source="replan-llm" target="replan-giveup" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Loop back arrow: apply-replan -> ready -->
    <mxCell id="e-apply-loop" value="回到執行迴圈" style="endArrow=classic;strokeColor=#9c27b0;strokeWidth=2;dashed=1;fontStyle=1;fontSize=10;fontColor=#7b1fa2;exitX=1;exitY=0;exitDx=0;exitDy=0;curved=1;" edge="1" source="apply-replan" target="ready" parent="1">
      <mxGeometry relative="1" as="geometry">
        <Array as="points">
          <mxPoint x="765" y="930"/>
          <mxPoint x="765" y="437"/>
        </Array>
      </mxGeometry>
    </mxCell>

    <!-- =========================================== -->
    <!-- ===== PHASE 3: AGGREGATION ===== -->
    <!-- =========================================== -->
    <mxCell id="phase3-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#5c6bc0;strokeWidth=1.5;dashed=1;arcSize=8;" vertex="1" parent="1">
      <mxGeometry x="150" y="1095" width="500" height="95" as="geometry"/>
    </mxCell>
    <mxCell id="phase3-label" value="Phase 3: Aggregation" style="text;html=1;fontSize=13;fontStyle=1;align=left;fillColor=none;strokeColor=none;fontColor=#3949ab;" vertex="1" parent="1">
      <mxGeometry x="160" y="1098" width="180" height="20" as="geometry"/>
    </mxCell>

    <mxCell id="aggregator" value="&lt;b&gt;Aggregator (LLM)&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10&quot;&gt;合併所有 step_outputs&lt;br&gt;產生最終連貫結果&lt;br&gt;語言跟隨原始 query&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#c5cae9;strokeColor=#5c6bc0;fontSize=11;arcSize=15;" vertex="1" parent="1">
      <mxGeometry x="195" y="1120" width="200" height="60" as="geometry"/>
    </mxCell>

    <mxCell id="final-result" value="&lt;b&gt;Final Result&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:10&quot;&gt;+ execution stats&lt;br&gt;+ plan.format()&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#c5cae9;strokeColor=#5c6bc0;fontSize=11;arcSize=15;" vertex="1" parent="1">
      <mxGeometry x="460" y="1123" width="150" height="55" as="geometry"/>
    </mxCell>

    <mxCell id="e-agg-result" style="endArrow=classic;strokeColor=#5c6bc0;strokeWidth=1.5;" edge="1" source="aggregator" target="final-result" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Arrow: execution phase -> aggregation -->
    <mxCell id="e-exec-agg" value="所有 steps 完成 / blocked" style="endArrow=classic;strokeColor=#333;strokeWidth=1.5;fontSize=10;fontColor=#333;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" source="phase2-box" target="phase3-box" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- ===== OUTPUT ===== -->
    <mxCell id="output" value="&lt;b&gt;Return to User&lt;/b&gt;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666;fontSize=13;fontStyle=1;arcSize=12;" vertex="1" parent="1">
      <mxGeometry x="320" y="1205" width="160" height="40" as="geometry"/>
    </mxCell>
    <mxCell id="e-result-out" style="endArrow=classic;strokeColor=#333;strokeWidth=1.5;" edge="1" source="final-result" target="output" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- ===== SANDBOX (side panel) ===== -->
    <mxCell id="sandbox-note" value="&lt;b&gt;SandboxManager&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;Docker container&lt;br&gt;MCP filesystem (R/W)&lt;br&gt;MCP filesystem (RO → Planner)&lt;br&gt;MCP shell (Docker exec)&lt;br&gt;User MCP (stdio/sse)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#efebe9;strokeColor=#8d6e63;fontSize=10;arcSize=12;align=left;spacingLeft=6;" vertex="1" parent="1">
      <mxGeometry x="20" y="125" width="180" height="95" as="geometry"/>
    </mxCell>

    <!-- Arrow: sandbox-note -> init -->
    <mxCell id="e-sandbox-init" style="endArrow=classic;strokeColor=#8d6e63;strokeWidth=1;dashed=1;exitX=1;exitY=0.3;exitDx=0;exitDy=0;entryX=0;entryY=0.3;entryDx=0;entryDy=0;" edge="1" source="sandbox-note" target="init" parent="1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- ===== CONFIG (side panel) ===== -->
    <mxCell id="config-note" value="&lt;b&gt;CortexConfig&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9&quot;&gt;model: ModelConfig (LiteLLM)&lt;br&gt;sandbox: SandboxConfig&lt;br&gt;executors: [ExecutorEntry]&lt;br&gt;mcp_servers: [MCPServer]&lt;br&gt;tuning: TuningConfig&lt;br&gt;&amp;nbsp; max_concurrent_steps: 3&lt;br&gt;&amp;nbsp; max_retries: 3&lt;br&gt;&amp;nbsp; max_replan_attempts: 2&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#efebe9;strokeColor=#8d6e63;fontSize=10;arcSize=12;align=left;spacingLeft=6;" vertex="1" parent="1">
      <mxGeometry x="600" y="105" width="180" height="122" as="geometry"/>
    </mxCell>

    <!-- ===== BaseAgent note ===== -->
    <mxCell id="base-note" value="&lt;font style=&quot;font-size:9&quot;&gt;&lt;b&gt;BaseAgent&lt;/b&gt; (共用基底)&lt;br&gt;• wrap Google ADK agents&lt;br&gt;• tool call tracking (pending/success)&lt;br&gt;• file extraction&lt;br&gt;• auto retry (malformed JSON, hallucinated tools)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#efebe9;strokeColor=#8d6e63;fontSize=9;arcSize=12;align=left;spacingLeft=6;" vertex="1" parent="1">
      <mxGeometry x="20" y="245" width="205" height="82" as="geometry"/>
    </mxCell>

  </root>
</mxGraphModel>